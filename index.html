<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Analizador de TermografÃ­a TZone</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial;
    padding: 20px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
}
.maximo {
    background-color: #ffdddd !important;
    font-weight: bold;
    color: red;
}
.minimo {
    background-color: #ddeaff !important;
    font-weight: bold;
    color: blue;
}
</style>
</head>

<body>

<h2>ğŸ“‰ Analizador de TermografÃ­a TZone</h2>

<input type="file" id="pdfInput" accept="application/pdf">
<button onclick="procesarPDF()">Procesar PDF</button>

<br><br>

<canvas id="grafico" height="120"></canvas>

<h3>Resultados Generales</h3>
<div id="extremos"></div>

<h3>Resultados</h3>
<table id="tabla">
<thead>
<tr>
    <th>Fecha</th>
    <th>Hora</th>
    <th>Temp (Â°C)</th>
    <th>Humedad (%)</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
let chart;

async function procesarPDF() {
    const archivo = document.getElementById("pdfInput").files[0];
    if (!archivo) {
        alert("Seleccione un PDF primero");
        return;
    }

    let form = new FormData();
    form.append("file", archivo);

    try {
        let resp = await fetch("https://tzone-backend-gqhn.onrender.com/procesar", {
            method: "POST",
            body: form
        });

        let data = await resp.json();

        if (!data.ok) {
            alert("Error: " + data.error);
            return;
        }

        const registros = data.registros;

        mostrarTabla(registros);
        generarGrafico(registros);
        calcularExtremos(registros);

    } catch (e) {
        alert("Error de conexiÃ³n con el servidor: " + e.message);
    }
}

// ------------------------------
// TABLA
// ------------------------------

function mostrarTabla(registros) {
    const tbody = document.querySelector("#tabla tbody");
    tbody.innerHTML = "";

    registros.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r.fecha}</td>
            <td>${r.hora}</td>
            <td>${r.temp}</td>
            <td>${r.humedad}</td>
        </tr>`;
    });
}

// ------------------------------
// GRAFICO
// ------------------------------

function generarGrafico(registros) {

    const labels = registros.map(r => r.fecha + " " + r.hora);
    const temps = registros.map(r => r.temp);
    const hums = registros.map(r => r.humedad);

    const ctx = document.getElementById("grafico");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Temperatura (Â°C)",
                    data: temps,
                    borderColor: "red",
                    backgroundColor: "rgba(255,0,0,0.3)"
                },
                {
                    label: "Humedad (%)",
                    data: hums,
                    borderColor: "blue",
                    backgroundColor: "rgba(0,0,255,0.3)"
                }
            ]
        }
    });
}

// ------------------------------
// MAXIMO Y MINIMO
// ------------------------------

function calcularExtremos(registros) {

    let max = registros.reduce((a,b) => a.temp > b.temp ? a : b);
    let min = registros.reduce((a,b) => a.temp < b.temp ? a : b);

    document.getElementById("extremos").innerHTML = `
        <p>ğŸ”¥ MÃ¡xima: <b>${max.temp}Â°C</b> â€” ${max.fecha} ${max.hora}, humedad: ${max.humedad}%</p>
        <p>â„ï¸ MÃ­nima: <b>${min.temp}Â°C</b> â€” ${min.fecha} ${min.hora}, humedad: ${min.humedad}%</p>
    `;

    // marcar tabla
    const filas = document.querySelectorAll("#tabla tbody tr");
    filas.forEach(fila => {
        const t = parseFloat(fila.children[2].innerText);
        const fecha = fila.children[0].innerText;
        const hora = fila.children[1].innerText;

        if (t === max.temp && fecha === max.fecha && hora === max.hora) {
            fila.classList.add("maximo");
        }
        if (t === min.temp && fecha === min.fecha && hora === min.hora) {
            fila.classList.add("minimo");
        }
    });
}
</script>

</body>
</html>
